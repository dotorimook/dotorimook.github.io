---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/Layout.astro';
import PageLayout from '../../components/PageLayout';
import PostListItem from '../../components/PostListItem';
import { slugify } from '../../utils/slugify';
import { generateExcerpt } from '../../utils/content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

  return uniqueTags
    .map(tag => {
      const slug = slugify(tag);
      if (!slug) return null;
      const filteredPosts = allPosts.filter(post => post.data.tags?.includes(tag));
      return {
        params: { tag: slug },
        props: { posts: filteredPosts, tagName: tag },
      };
    })
    .filter(Boolean);
}

const { tag } = Astro.params;
const { posts, tagName } = Astro.props;

// Sort posts by date
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Adapt Astro posts to PostListItem interface
const adaptedPosts = sortedPosts.map(post => ({
  id: post.id,
  excerpt: post.data.description || generateExcerpt(post.body || ''),
  fields: {
    slug: `/blog/${post.slug}/`,
  },
  frontmatter: {
    title: post.data.title,
    categories: post.data.categories || [],
    tags: post.data.tags || post.data.tag || [],
    date: post.data.date.toISOString(),
    description: post.data.description,
  }
}));
---

<BaseLayout title={`Tag: ${tagName}`}>
  <PageLayout client:load title={`Tag: ${tagName}`}>
    <h1>Tag: {tagName}</h1>
    {adaptedPosts.map((post) => (
      <PostListItem post={post} client:visible />
    ))}
  </PageLayout>
</BaseLayout>
