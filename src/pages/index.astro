---
import Layout from '../layouts/Layout.astro';
import PageLayout from '../components/PageLayout';
import PostListItem from '../components/PostListItem';
import HeroPost from '../components/HeroPost';
import { getCollection } from 'astro:content';
import { getExcerpt } from '../utils/excerpt';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const heroPost = posts[0];
const otherPosts = posts.slice(1);

const tags = [...new Set(posts.flatMap(p => p.data.tags || []))];
const categories = [...new Set(posts.flatMap(p => p.data.categories || []))];
---

<Layout title="Dotorimook's Blog">
	<PageLayout client:load title="Dotorimook's Blog" tags={tags} categories={categories}>
		{
			heroPost && (
				<HeroPost
					client:load
					post={{
						id: heroPost.id,
						excerpt: heroPost.data.description || getExcerpt(heroPost.body),
						fields: {
							slug: `/blog/${heroPost.slug}/`,
						},
						frontmatter: {
							title: heroPost.data.title,
							categories: heroPost.data.categories || [],
							tags: heroPost.data.tags || [],
							date: heroPost.data.date.toISOString(),
							description: heroPost.data.description,
						},
					}}
				/>
			)
		}
		{
			otherPosts.map((post) => (
				<PostListItem
					client:load
					post={{
						id: post.id,
						excerpt: post.data.description || getExcerpt(post.body),
						fields: {
							slug: `/blog/${post.slug}/`,
						},
						frontmatter: {
							title: post.data.title,
							categories: post.data.categories || [],
							tags: post.data.tags || [],
							date: post.data.date.toISOString(),
							description: post.data.description,
						},
					}}
				/>
			))
		}
	</PageLayout>
</Layout>
